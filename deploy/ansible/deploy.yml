- name: Deploy Bookmark app on EC2 using Docker Compose
  hosts: bookmark
  become: true

  vars:
    app_dir: /opt/bookmark

  tasks:
    - name: Create app directory
      file:
        path: "{{ app_dir }}"
        state: directory
        mode: "0755"

    - name: Upload docker compose file
      copy:
        src: docker-compose.prod.yml
        dest: "{{ app_dir }}/docker-compose.yml"
        mode: "0644"

    - name: Upload backend env file
      copy:
        src: backend.env
        dest: "{{ app_dir }}/backend.env"
        mode: "0600"

    - name: Pull images
      shell: |
        cd {{ app_dir }}
        docker compose pull
      args:
        executable: /bin/bash

    - name: Start containers
      shell: |
        cd {{ app_dir }}
        docker compose up -d
      args:
        executable: /bin/bash

    - name: Show running containers
      shell: |
        cd {{ app_dir }}
        docker compose ps
      args:
        executable: /bin/bash
      register: ps_out

    - debug:
        var: ps_out.stdout
