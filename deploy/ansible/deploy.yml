- name: Deploy Bookmark app on EC2 using Docker Compose
  hosts: bookmark
  become: true

  vars:
    app_dir: /opt/bookmark
    compose_dest: "{{ app_dir }}/docker-compose.yml"
    env_dest: "{{ app_dir }}/backend.env"

  pre_tasks:
    - name: Install Docker & Compose (required for deployment)
      import_tasks: install-docker.yml

    - name: Check if backend.env exists on controller (Jenkins/WSL)
      delegate_to: localhost
      become: false
      stat:
        path: "{{ playbook_dir }}/backend.env"
      register: backend_env_local

    - name: Check if backend.env already exists on server
      stat:
        path: "{{ env_dest }}"
      register: backend_env_remote

  tasks:
    - name: Ensure app directory exists
      file:
        path: "{{ app_dir }}"
        state: directory
        mode: "0755"

    - name: Upload docker compose file
      copy:
        src: docker-compose.prod.yml
        dest: "{{ compose_dest }}"
        mode: "0644"

    - name: Upload backend env file if present locally (manual runs)
      copy:
        src: backend.env
        dest: "{{ env_dest }}"
        mode: "0600"
      when: backend_env_local.stat.exists

    - name: Fail if no backend.env locally AND none on server
      fail:
        msg: "backend.env not found locally (Jenkins) and not found on server at {{ env_dest }}. Create it on the EC2 server."
      when: (not backend_env_local.stat.exists) and (not backend_env_remote.stat.exists)

    - name: Pull latest images and start containers
      shell: |
        set -e
        cd "{{ app_dir }}"
        docker compose up -d --pull always
      args:
        executable: /bin/bash

    - name: Show running containers
      shell: |
        set -e
        cd "{{ app_dir }}"
        docker compose ps
      args:
        executable: /bin/bash
      register: ps_out

    - name: Print docker compose status
      debug:
        var: ps_out.stdout
