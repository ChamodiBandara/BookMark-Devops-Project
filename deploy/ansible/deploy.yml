- name: Deploy Bookmark app on EC2 using Docker Compose
  hosts: bookmark
  become: true

  vars:
    app_dir: /opt/bookmark
    compose_dest: "{{ app_dir }}/docker-compose.yml"
    env_dest: "{{ app_dir }}/backend.env"

  pre_tasks:
    - name: Install Docker & Compose (required for deployment)
      import_tasks: install-docker.yml

  tasks:
    - name: Ensure app directory exists
      file:
        path: "{{ app_dir }}"
        state: directory
        mode: "0755"

    - name: Upload docker compose file
      copy:
        src: docker-compose.prod.yml
        dest: "{{ compose_dest }}"
        mode: "0644"

    - name: Upload backend env file (server secret)
      copy:
        src: backend.env
        dest: "{{ env_dest }}"
        mode: "0600"

    - name: Pull latest images and start containers
      shell: |
        set -e
        cd "{{ app_dir }}"
        docker compose up -d --pull always
      args:
        executable: /bin/bash

    - name: Show running containers
      shell: |
        set -e
        cd "{{ app_dir }}"
        docker compose ps
      args:
        executable: /bin/bash
      register: ps_out

    - name: Print docker compose status
      debug:
        var: ps_out.stdout
